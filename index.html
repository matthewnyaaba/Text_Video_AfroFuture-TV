<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Afrofuture TV Studio (Colab)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      padding:18px;
      color:#111;
    }
    .container{max-width:1280px;margin:0 auto}
    .header{
      color:#fff;text-align:center;margin-bottom:18px;
      padding:18px;border-radius:18px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,0.18);
    }
    .header h1{font-size:2.2rem;letter-spacing:0.5px;margin-bottom:6px}
    .header p{opacity:0.95}
    .card{
      background:#fff;border-radius:18px;padding:22px;
      box-shadow:0 18px 50px rgba(0,0,0,0.25);
    }
    .tabs{
      display:flex;flex-wrap:wrap;gap:10px;
      border-bottom:2px solid #eee;padding-bottom:12px;margin-bottom:18px;
    }
    .tab{
      border:0;cursor:pointer;
      padding:12px 14px;border-radius:12px;
      background:#f3f4f6;color:#333;
      font-weight:700;
      transition:0.2s;
    }
    .tab.active{background:#eef2ff;color:#3730a3}
    .tab:hover{transform:translateY(-1px)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .section-title{font-size:1.15rem;margin:10px 0 12px 0;color:#111}
    .form-group{margin-bottom:14px}
    label{display:block;margin-bottom:6px;font-weight:700;color:#222}
    input[type="text"], input[type="password"], input[type="number"], textarea, select{
      width:100%;padding:12px;border-radius:10px;border:2px solid #e5e7eb;
      font-size:1rem;transition:0.2s;
    }
    textarea{min-height:140px;resize:vertical}
    input:focus,textarea:focus,select:focus{outline:none;border-color:#667eea}
    .help{font-size:0.92rem;color:#555;margin-top:6px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:0;cursor:pointer;border-radius:12px;
      padding:13px 16px;font-weight:800;font-size:1rem;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;transition:0.2s;width:100%;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,0.35)}
    .btn.secondary{background:#111827}
    .btn.light{background:#f3f4f6;color:#111;border:2px solid #e5e7eb}
    .pill{
      display:inline-block;padding:6px 10px;border-radius:999px;
      background:#f3f4f6;color:#111;font-weight:800;font-size:0.9rem
    }
    .notice{
      background:#fff7ed;border:2px solid #fdba74;
      border-radius:12px;padding:12px;color:#7c2d12;margin-bottom:14px
    }
    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:12px;background:#f9fafb;border:2px solid #eee
    }
    .toggle input{transform:scale(1.2)}
    .provider-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:12px;margin-top:10px
    }
    .provider{
      border:2px solid #e5e7eb;border-radius:14px;padding:14px;
      cursor:pointer;transition:0.2s;background:#fff
    }
    .provider:hover{transform:translateY(-2px);border-color:#a5b4fc;box-shadow:0 10px 22px rgba(99,102,241,0.15)}
    .provider.selected{border-color:#6366f1;background:#eef2ff}
    .provider h4{margin-bottom:6px;color:#3730a3}
    .small{font-size:0.92rem;color:#555;line-height:1.35}
    .hr{height:1px;background:#eee;margin:14px 0}
    .progress{
      margin-top:14px;padding:14px;border-radius:14px;background:#111827;color:#e5e7eb;
      display:none
    }
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";font-size:0.92rem;white-space:pre-wrap}
    .result{
      margin-top:14px;padding:14px;border-radius:14px;background:#eef2ff;border:2px solid #c7d2fe;display:none
    }
    .result a{display:inline-block;margin-top:10px}
    .speaker-card{
      border:2px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff
    }
    .speaker-card h4{margin-bottom:10px;color:#111827}
    .scene-item{
      padding:12px;border-radius:12px;background:#f9fafb;border:2px solid #eee;margin-bottom:10px
    }
    .codebox{
      background:#0b1220;color:#e5e7eb;border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.08)
    }
    .codebox pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé¨ AFROFUTURE TV STUDIO</h1>
      <p>Colab-first production app: Script ‚Üí Voice ‚Üí Talking Video ‚Üí Scenes ‚Üí Captions ‚Üí Final episode</p>
      <p style="margin-top:6px;font-size:0.95rem;opacity:0.95">Presenter: Crispina Atiamah Nyaaba</p>
    </div>

    <div class="card">
      <div class="notice">
        <strong>Important:</strong> This page is designed to run inside Google Colab, because it needs a Python backend.
        You will load it from your GitHub raw URL inside Colab.
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('setup')">‚öôÔ∏è Setup</button>
        <button class="tab" onclick="switchTab('script')">üìù Script</button>
        <button class="tab" onclick="switchTab('studio')">üé® Studio</button>
        <button class="tab" onclick="switchTab('panel')">üë• Panel</button>
        <button class="tab" onclick="switchTab('scenes')">üé• Scenes</button>
        <button class="tab" onclick="switchTab('produce')">üöÄ Produce</button>
        <button class="tab" onclick="switchTab('code')">üì¶ Generate Code</button>
      </div>

      <!-- SETUP -->
      <div id="setup" class="tab-content">
        <div class="grid">
          <div>
            <div class="section-title">Keys and Providers</div>

            <div class="form-group">
              <label>OpenAI API Key (Script, OpenAI TTS, Captions, Sora Scenes)</label>
              <input type="password" id="openaiKey" placeholder="sk-..." />
              <div class="help">Used for script generation, OpenAI TTS, transcription captions, and Sora scenes (optional).</div>
            </div>

            <div class="form-group">
              <label>ElevenLabs API Key (Voice)</label>
              <input type="password" id="elevenKey" placeholder="..." />
            </div>

            <div class="form-group">
              <label>D-ID API Key (Talking Head)</label>
              <input type="password" id="didKey" placeholder="..." />
              <div class="help">Use D-ID if you want the presenter talking-head video.</div>
            </div>

            <div class="form-group">
              <label>HeyGen API Key (Optional)</label>
              <input type="password" id="heygenKey" placeholder="..." />
              <div class="help">UI supports selection. Backend is placeholder until you add HeyGen endpoint logic.</div>
            </div>

            <div class="form-group">
              <label>Synthesia API Key (Optional)</label>
              <input type="password" id="synthesiaKey" placeholder="..." />
              <div class="help">UI supports selection. Backend is placeholder until you add Synthesia endpoint logic.</div>
            </div>

            <button class="btn" onclick="saveSetup()">üíæ Save Setup</button>
          </div>

          <div>
            <div class="section-title">Default Content and Media</div>

            <div class="form-group">
              <label>Presenter Image</label>
              <div class="row">
                <button class="btn light" style="flex:1" onclick="uploadImage('main')">üì§ Upload in Colab</button>
                <button class="btn light" style="flex:1" onclick="setImageUrl('main')">üîó Use Public URL</button>
              </div>
              <div class="help">D-ID needs a public image URL. Colab upload will automatically create a public link.</div>
              <div style="margin-top:8px">
                <span class="pill">Image status:</span>
                <span id="mainImageStatus" class="pill" style="margin-left:6px">Not set</span>
              </div>
            </div>

            <div class="form-group">
              <label>Voice Mode (Main Presenter)</label>
              <select id="voiceModeMain" onchange="renderVoiceFields()">
                <option value="eleven_tts">ElevenLabs TTS</option>
                <option value="eleven_voiceid">ElevenLabs Voice ID (clone-style)</option>
                <option value="openai_tts">OpenAI TTS (gpt-4o-mini-tts)</option>
                <option value="upload_audio">Upload Audio (Use your own)</option>
              </select>
              <div class="help">If you choose Upload Audio, the script step can be skipped.</div>
            </div>

            <div id="voiceExtraMain"></div>

            <div class="form-group">
              <label>Spoken Language (Voice)</label>
              <select id="spokenLang">
                <option value="en" selected>English</option>
                <option value="fr">French</option>
                <option value="pt">Portuguese</option>
                <option value="es">Spanish</option>
                <option value="ar">Arabic</option>
                <option value="sw">Swahili</option>
                <option value="ha">Hausa</option>
                <option value="yo">Yoruba</option>
                <option value="am">Amharic</option>
              </select>
            </div>

            <div class="form-group">
              <label>Captions Language (SRT)</label>
              <select id="captionLang">
                <option value="same" selected>Same as spoken language</option>
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="pt">Portuguese</option>
                <option value="es">Spanish</option>
                <option value="ar">Arabic</option>
                <option value="sw">Swahili</option>
                <option value="ha">Hausa</option>
                <option value="yo">Yoruba</option>
                <option value="am">Amharic</option>
              </select>
              <div class="help">Captions are generated from transcription, then optionally translated to your selected captions language.</div>
            </div>

            <div class="toggle">
              <input type="checkbox" id="enableCaptions" checked />
              <label for="enableCaptions" style="margin:0">Generate captions (SRT)</label>
            </div>

            <div class="toggle" style="margin-top:10px">
              <input type="checkbox" id="burnCaptions" />
              <label for="burnCaptions" style="margin:0">Burn captions into final video (hard subtitles)</label>
            </div>

            <button class="btn secondary" style="margin-top:14px" onclick="switchTab('script')">Next: Script ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- SCRIPT -->
      <div id="script" class="tab-content" style="display:none">
        <div class="grid">
          <div>
            <div class="section-title">Generate a Script (Optional)</div>

            <div class="form-group">
              <label>Script Mode</label>
              <select id="scriptMode" onchange="renderScriptMode()">
                <option value="topics">Generate from topics</option>
                <option value="custom" selected>Use my own script</option>
              </select>
            </div>

            <div id="topicsBox" style="display:none">
              <div class="form-group">
                <label>Topics (comma-separated)</label>
                <textarea id="topics" placeholder="AI in African education, AI startups in Ghana, responsible AI policy..."></textarea>
              </div>

              <div class="form-group">
                <label>Style</label>
                <select id="scriptStyle">
                  <option value="news" selected>News bulletin</option>
                  <option value="documentary">Documentary narration</option>
                  <option value="panel">Panel discussion script</option>
                  <option value="presentation">Presentation style</option>
                </select>
              </div>

              <div class="form-group">
                <label>Length (minutes)</label>
                <select id="scriptMinutes">
                  <option value="3">3</option>
                  <option value="5" selected>5</option>
                  <option value="7">7</option>
                  <option value="10">10</option>
                </select>
                <div class="help">Approx. 150 words per minute.</div>
              </div>

              <button class="btn" onclick="generateScript()">üß† Generate Script</button>
              <div class="help">Uses OpenAI if your OpenAI key is set.</div>
            </div>
          </div>

          <div>
            <div class="section-title">Script Editor</div>
            <div class="form-group">
              <label>Main Script</label>
              <textarea id="mainScript" placeholder="Welcome to Afrofuture TV. I am Crispina Atiamah Nyaaba..."></textarea>
              <div class="help">If you want panel mode, add speaker turns like: <strong>[Crispina]</strong> ... <strong>[Guest 1]</strong> ...</div>
            </div>

            <div class="form-group">
              <label>News Ticker (bottom text overlay)</label>
              <input type="text" id="ticker" placeholder="Breaking: Afrofuture AI TV highlights responsible innovation across Africa..." />
            </div>

            <button class="btn" onclick="saveScript()">üíæ Save Script</button>
            <button class="btn light" style="margin-top:10px" onclick="switchTab('studio')">Next: Studio ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- STUDIO -->
      <div id="studio" class="tab-content" style="display:none">
        <div class="section-title">Studio Style and Demonstration Description</div>

        <div class="provider-grid" id="studioGrid">
          <div class="provider selected" onclick="selectStudio('modern', this)">
            <h4>Modern Studio</h4>
            <div class="small">Clean studio, LED wall, news ambience</div>
          </div>
          <div class="provider" onclick="selectStudio('scifi', this)">
            <h4>Sci-Fi Command</h4>
            <div class="small">Futuristic command room, holograms</div>
          </div>
          <div class="provider" onclick="selectStudio('presentation', this)">
            <h4>Presentation</h4>
            <div class="small">Slides, charts, lecture visuals</div>
          </div>
          <div class="provider" onclick="selectStudio('standing', this)">
            <h4>Standing Mode</h4>
            <div class="small">Presenter in front of screen, talk show style</div>
          </div>
        </div>

        <div class="form-group" style="margin-top:14px">
          <label>What should the studio show (screens, demos, props, visuals)?</label>
          <textarea id="studioDesc" placeholder="Example: LED wall showing AI education maps of Africa; side screen showing charts; subtle Afrofuture logo..."></textarea>
        </div>

        <div class="toggle">
          <input type="checkbox" id="enableTicker" checked />
          <label for="enableTicker" style="margin:0">Enable news ticker overlay</label>
        </div>

        <button class="btn" style="margin-top:14px" onclick="saveStudio()">üíæ Save Studio</button>
        <button class="btn light" style="margin-top:10px" onclick="switchTab('panel')">Next: Panel ‚Üí</button>
      </div>

      <!-- PANEL -->
      <div id="panel" class="tab-content" style="display:none">
        <div class="section-title">Panel Discussion Mode (Optional)</div>

        <div class="toggle">
          <input type="checkbox" id="enablePanel" onchange="renderPanel()" />
          <label for="enablePanel" style="margin:0">Enable panel mode (multiple speakers / avatars)</label>
        </div>

        <div id="panelBox" style="display:none;margin-top:14px">
          <div class="form-group">
            <label>Number of speakers</label>
            <select id="panelCount" onchange="renderPanelSpeakers()">
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
            </select>
            <div class="help">Each speaker can have a different image and voice mode.</div>
          </div>

          <div id="speakers"></div>

          <div class="help" style="margin-top:10px">
            For best results, format the script with speaker tags like: <strong>[Crispina]</strong>, <strong>[Guest 1]</strong>.
            The backend will split lines by speaker and produce separate segments.
          </div>
        </div>

        <button class="btn" style="margin-top:14px" onclick="savePanel()">üíæ Save Panel Settings</button>
        <button class="btn light" style="margin-top:10px" onclick="switchTab('scenes')">Next: Scenes ‚Üí</button>
      </div>

      <!-- SCENES -->
      <div id="scenes" class="tab-content" style="display:none">
        <div class="section-title">Scenes and Inserts (B-roll, Sora, uploads)</div>

        <div class="grid">
          <div>
            <div class="form-group">
              <label>Scene source</label>
              <select id="sceneProvider">
                <option value="none" selected>No generated scenes</option>
                <option value="openai_sora">OpenAI Sora (v1/videos)</option>
                <option value="upload">Upload video inserts</option>
              </select>
              <div class="help">You can add multiple scenes; they will be inserted between segments in the final composition.</div>
            </div>

            <div class="hr"></div>

            <div class="form-group">
              <label>Scene description (for Sora) or label (for upload)</label>
              <textarea id="sceneDesc" placeholder="Example: A futuristic African classroom using AI tools responsibly..."></textarea>
            </div>

            <div class="form-group">
              <label>Insert after segment number</label>
              <input type="number" id="insertAfter" value="1" min="0" />
              <div class="help">Segment numbers start from 1 (first main segment). Use 0 to insert before the first segment.</div>
            </div>

            <div class="form-group">
              <label>Duration (seconds) for Sora (allowed: 4, 8, 12)</label>
              <select id="sceneSeconds">
                <option value="4" selected>4</option>
                <option value="8">8</option>
                <option value="12">12</option>
              </select>
              <div class="help">Sora duration choices are limited by the API options. :contentReference[oaicite:1]{index=1}</div>
            </div>

            <div class="row">
              <button class="btn light" style="flex:1" onclick="addScene()">‚ûï Add to timeline</button>
              <button class="btn light" style="flex:1" onclick="uploadBroll()">üì§ Upload a video insert</button>
            </div>
          </div>

          <div>
            <div class="section-title">Timeline</div>
            <div id="sceneList"></div>
            <button class="btn" onclick="saveScenes()">üíæ Save Scenes</button>
            <button class="btn light" style="margin-top:10px" onclick="switchTab('produce')">Next: Produce ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- PRODUCE -->
      <div id="produce" class="tab-content" style="display:none">
        <div class="section-title">Production Settings</div>

        <div class="grid">
          <div>
            <div class="form-group">
              <label>Talking-head provider</label>
              <div class="provider-grid">
                <div class="provider selected" onclick="selectTalkProvider('did', this)">
                  <h4>D-ID (Implemented)</h4>
                  <div class="small">Talking avatar from image + audio</div>
                </div>
                <div class="provider" onclick="selectTalkProvider('heygen', this)">
                  <h4>HeyGen (UI only)</h4>
                  <div class="small">Backend placeholder</div>
                </div>
                <div class="provider" onclick="selectTalkProvider('synthesia', this)">
                  <h4>Synthesia (UI only)</h4>
                  <div class="small">Backend placeholder</div>
                </div>
              </div>
            </div>

            <div class="toggle">
              <input type="checkbox" id="autoPreview" checked />
              <label for="autoPreview" style="margin:0">Preview video inside Colab after generation</label>
            </div>

            <div class="toggle" style="margin-top:10px">
              <input type="checkbox" id="autoDownload" checked />
              <label for="autoDownload" style="margin:0">Auto download final files</label>
            </div>

            <button class="btn" style="margin-top:14px;font-size:1.15rem" onclick="startProduction()">üé¨ Start Production</button>

            <div class="progress" id="progressBox">
              <div style="font-weight:900;margin-bottom:8px">Production Log</div>
              <div class="log" id="log"></div>
            </div>

            <div class="result" id="resultBox">
              <div style="font-weight:900;margin-bottom:8px;color:#3730a3">‚úÖ Completed</div>
              <div id="resultText"></div>
            </div>
          </div>

          <div>
            <div class="section-title">Summary</div>
            <div class="scene-item">
              <div><strong>Presenter image:</strong> <span id="sumImage">Not set</span></div>
              <div><strong>Voice mode:</strong> <span id="sumVoice">Not set</span></div>
              <div><strong>Spoken language:</strong> <span id="sumSpoken">en</span></div>
              <div><strong>Captions:</strong> <span id="sumCaps">On</span></div>
              <div><strong>Panel mode:</strong> <span id="sumPanel">Off</span></div>
              <div><strong>Scenes:</strong> <span id="sumScenes">0</span></div>
              <div><strong>Talking provider:</strong> <span id="sumTalk">did</span></div>
            </div>

            <div class="help">
              If any required key is missing, the backend will stop and report exactly what is missing.
            </div>
          </div>
        </div>
      </div>

      <!-- CODE -->
      <div id="code" class="tab-content" style="display:none">
        <div class="section-title">Generate a ready-to-run config (for your notes)</div>
        <div class="help" style="margin-bottom:12px">
          This creates a single configuration object that matches everything you selected on the interface.
          It is helpful for saving your setup, or for debugging.
        </div>

        <button class="btn light" onclick="generateConfigCode()">‚öôÔ∏è Generate Config</button>
        <div style="height:10px"></div>
        <div class="codebox">
          <pre id="configCode">Click ‚ÄúGenerate Config‚Äù.</pre>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn light" style="flex:1" onclick="copyConfig()">üìã Copy</button>
          <button class="btn" style="flex:1" onclick="downloadConfig()">‚¨áÔ∏è Download JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Global app state
    // -----------------------------
    let state = {
      setup: {
        openaiKey: "",
        elevenKey: "",
        didKey: "",
        heygenKey: "",
        synthesiaKey: ""
      },
      media: {
        mainImageUrl: "",
        mainImageLabel: "",
        uploadedAudioLabel: "",
        uploadedBroll: [] // {label, fileToken}
      },
      script: {
        mode: "custom",
        topics: "",
        style: "news",
        minutes: 5,
        text: "",
        ticker: ""
      },
      studio: {
        style: "modern",
        desc: "",
        enableTicker: true
      },
      voice: {
        mainMode: "eleven_tts",
        elevenVoiceId: "",
        openaiVoice: "alloy"
      },
      languages: {
        spoken: "en",
        captions: "same"
      },
      captions: {
        enable: true,
        burn: false
      },
      panel: {
        enable: false,
        count: 3,
        speakers: []
      },
      scenes: [],
      produce: {
        talkProvider: "did",
        autoPreview: true,
        autoDownload: true
      }
    };

    function persist() {
      localStorage.setItem("afrofuture_state", JSON.stringify(state));
      refreshSummary();
    }
    function load() {
      const raw = localStorage.getItem("afrofuture_state");
      if (!raw) return;
      try { state = JSON.parse(raw); } catch(e) {}
    }

    function switchTab(id){
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
      // Activate tab button
      const btn = Array.from(document.querySelectorAll(".tab")).find(b => b.getAttribute("onclick").includes(id));
      if (btn) btn.classList.add("active");
      document.getElementById(id).style.display = "block";
      refreshSummary();
    }

    // -----------------------------
    // Setup and media
    // -----------------------------
    function saveSetup(){
      state.setup.openaiKey = document.getElementById("openaiKey").value.trim();
      state.setup.elevenKey = document.getElementById("elevenKey").value.trim();
      state.setup.didKey = document.getElementById("didKey").value.trim();
      state.setup.heygenKey = document.getElementById("heygenKey").value.trim();
      state.setup.synthesiaKey = document.getElementById("synthesiaKey").value.trim();

      state.voice.mainMode = document.getElementById("voiceModeMain").value;
      state.languages.spoken = document.getElementById("spokenLang").value;
      state.languages.captions = document.getElementById("captionLang").value;

      state.captions.enable = document.getElementById("enableCaptions").checked;
      state.captions.burn = document.getElementById("burnCaptions").checked;

      // Extra voice fields handled in renderVoiceFields()
      const vId = document.getElementById("elevenVoiceIdMain");
      if (vId) state.voice.elevenVoiceId = vId.value.trim();
      const oa = document.getElementById("openaiVoiceMain");
      if (oa) state.voice.openaiVoice = oa.value;

      persist();
      alert("‚úÖ Setup saved.");
    }

    function renderVoiceFields(){
      const box = document.getElementById("voiceExtraMain");
      const mode = document.getElementById("voiceModeMain").value;
      let html = "";

      if (mode === "eleven_voiceid"){
        html += `
          <div class="form-group">
            <label>ElevenLabs Voice ID</label>
            <input type="text" id="elevenVoiceIdMain" placeholder="Example: 21m00Tcm4TlvDq8ikWAM" value="${state.voice.elevenVoiceId || ""}">
            <div class="help">Paste your ElevenLabs voice ID here.</div>
          </div>
        `;
      } else if (mode === "openai_tts"){
        html += `
          <div class="form-group">
            <label>OpenAI Voice</label>
            <select id="openaiVoiceMain">
              <option value="alloy">alloy</option>
              <option value="verse">verse</option>
              <option value="aria">aria</option>
              <option value="nova">nova</option>
              <option value="sage">sage</option>
              <option value="ember">ember</option>
            </select>
            <div class="help">OpenAI Audio TTS voices. :contentReference[oaicite:2]{index=2}</div>
          </div>
        `;
      } else if (mode === "upload_audio"){
        html += `
          <div class="form-group">
            <label>Upload Audio</label>
            <button class="btn light" onclick="uploadAudio()">üé§ Upload audio file (mp3/wav)</button>
            <div style="margin-top:8px">
              <span class="pill">Audio status:</span>
              <span class="pill" id="audioStatus" style="margin-left:6px">${state.media.uploadedAudioLabel || "Not set"}</span>
            </div>
          </div>
        `;
      }

      box.innerHTML = html;

      // Re-select OpenAI voice in dropdown if present
      const oa = document.getElementById("openaiVoiceMain");
      if (oa) oa.value = state.voice.openaiVoice || "alloy";
    }

    function uploadImage(which){
      // Colab callback
      if (!window.google || !google.colab || !google.colab.kernel) {
        alert("This must run inside Google Colab output.");
        return;
      }
      google.colab.kernel.invokeFunction("afrofuture.upload_image", [which], {});
    }

    function setImageUrl(which){
      const url = prompt("Paste a public image URL:");
      if (!url) return;
      if (which === "main"){
        state.media.mainImageUrl = url.trim();
        state.media.mainImageLabel = "URL set";
        document.getElementById("mainImageStatus").textContent = "URL set";
      }
      persist();
      alert("‚úÖ Image URL saved.");
    }

    function uploadAudio(){
      if (!window.google || !google.colab || !google.colab.kernel) {
        alert("This must run inside Google Colab output.");
        return;
      }
      google.colab.kernel.invokeFunction("afrofuture.upload_audio", [], {});
    }

    function uploadBroll(){
      if (!window.google || !google.colab || !google.colab.kernel) {
        alert("This must run inside Google Colab output.");
        return;
      }
      google.colab.kernel.invokeFunction("afrofuture.upload_broll", [], {});
    }

    // -----------------------------
    // Script
    // -----------------------------
    function renderScriptMode(){
      const mode = document.getElementById("scriptMode").value;
      state.script.mode = mode;
      document.getElementById("topicsBox").style.display = (mode === "topics") ? "block" : "none";
      persist();
    }

    function generateScript(){
      const openaiKey = (document.getElementById("openaiKey").value || "").trim();
      if (!openaiKey){
        alert("Please set OpenAI key in Setup first.");
        return;
      }
      const topics = document.getElementById("topics").value.trim();
      if (!topics){
        alert("Please enter topics.");
        return;
      }
      state.script.topics = topics;
      state.script.style = document.getElementById("scriptStyle").value;
      state.script.minutes = parseInt(document.getElementById("scriptMinutes").value, 10);

      persist();

      google.colab.kernel.invokeFunction(
        "afrofuture.generate_script",
        [JSON.stringify({
          openaiKey,
          topics: state.script.topics,
          style: state.script.style,
          minutes: state.script.minutes,
          spokenLang: document.getElementById("spokenLang").value
        })],
        {}
      );
    }

    function saveScript(){
      state.script.mode = document.getElementById("scriptMode").value;
      state.script.text = document.getElementById("mainScript").value;
      state.script.ticker = document.getElementById("ticker").value.trim();
      persist();
      alert("‚úÖ Script saved.");
    }

    // -----------------------------
    // Studio
    // -----------------------------
    function selectStudio(style, el){
      state.studio.style = style;
      document.querySelectorAll("#studioGrid .provider").forEach(p=>p.classList.remove("selected"));
      el.classList.add("selected");
      persist();
    }

    function saveStudio(){
      state.studio.desc = document.getElementById("studioDesc").value;
      state.studio.enableTicker = document.getElementById("enableTicker").checked;
      persist();
      alert("‚úÖ Studio saved.");
    }

    // -----------------------------
    // Panel
    // -----------------------------
    function renderPanel(){
      state.panel.enable = document.getElementById("enablePanel").checked;
      document.getElementById("panelBox").style.display = state.panel.enable ? "block" : "none";
      renderPanelSpeakers();
      persist();
    }

    function renderPanelSpeakers(){
      if (!document.getElementById("panelCount")) return;
      state.panel.count = parseInt(document.getElementById("panelCount").value, 10);

      // Initialize speakers if missing
      if (!Array.isArray(state.panel.speakers)) state.panel.speakers = [];
      while (state.panel.speakers.length < state.panel.count){
        state.panel.speakers.push({
          name: `Speaker ${state.panel.speakers.length + 1}`,
          imageUrl: "",
          voiceMode: "eleven_tts",
          elevenVoiceId: "",
          openaiVoice: "alloy"
        });
      }
      state.panel.speakers = state.panel.speakers.slice(0, state.panel.count);

      const holder = document.getElementById("speakers");
      let html = "";
      for (let i=0;i<state.panel.count;i++){
        const sp = state.panel.speakers[i];
        html += `
          <div class="speaker-card" style="margin-bottom:12px">
            <h4>Speaker ${i+1}</h4>
            <div class="form-group">
              <label>Name (must match your script tags if you use [Name])</label>
              <input type="text" id="spName_${i}" value="${sp.name}">
            </div>

            <div class="form-group">
              <label>Image</label>
              <div class="row">
                <button class="btn light" style="flex:1" onclick="uploadPanelImage(${i})">üì§ Upload in Colab</button>
                <button class="btn light" style="flex:1" onclick="setPanelImageUrl(${i})">üîó Use Public URL</button>
              </div>
              <div style="margin-top:8px">
                <span class="pill">Status:</span>
                <span class="pill" id="spImgStatus_${i}" style="margin-left:6px">${sp.imageUrl ? "URL set" : "Not set"}</span>
              </div>
            </div>

            <div class="form-group">
              <label>Voice mode</label>
              <select id="spVoice_${i}" onchange="renderSpeakerExtra(${i})">
                <option value="eleven_tts">ElevenLabs TTS</option>
                <option value="eleven_voiceid">ElevenLabs Voice ID</option>
                <option value="openai_tts">OpenAI TTS</option>
                <option value="upload_audio">Upload Audio (per-speaker not supported yet)</option>
              </select>
              <div class="help">Per-speaker audio upload is not supported yet. Use TTS per speaker for now.</div>
            </div>

            <div id="spExtra_${i}"></div>
          </div>
        `;
      }
      holder.innerHTML = html;

      // Set defaults and render extras
      for (let i=0;i<state.panel.count;i++){
        const sp = state.panel.speakers[i];
        const sel = document.getElementById(`spVoice_${i}`);
        sel.value = sp.voiceMode || "eleven_tts";
        renderSpeakerExtra(i);
      }

      persist();
    }

    function renderSpeakerExtra(i){
      const mode = document.getElementById(`spVoice_${i}`).value;
      state.panel.speakers[i].voiceMode = mode;
      const box = document.getElementById(`spExtra_${i}`);
      let html = "";
      if (mode === "eleven_voiceid"){
        html += `
          <div class="form-group">
            <label>ElevenLabs Voice ID</label>
            <input type="text" id="spElevenId_${i}" value="${state.panel.speakers[i].elevenVoiceId || ""}" placeholder="Voice ID">
          </div>
        `;
      } else if (mode === "openai_tts"){
        html += `
          <div class="form-group">
            <label>OpenAI Voice</label>
            <select id="spOpenaiVoice_${i}">
              <option value="alloy">alloy</option>
              <option value="verse">verse</option>
              <option value="aria">aria</option>
              <option value="nova">nova</option>
              <option value="sage">sage</option>
              <option value="ember">ember</option>
            </select>
          </div>
        `;
      }
      box.innerHTML = html;

      const o = document.getElementById(`spOpenaiVoice_${i}`);
      if (o) o.value = state.panel.speakers[i].openaiVoice || "alloy";

      persist();
    }

    function uploadPanelImage(i){
      if (!window.google || !google.colab || !google.colab.kernel) {
        alert("This must run inside Google Colab output.");
        return;
      }
      google.colab.kernel.invokeFunction("afrofuture.upload_panel_image", [i], {});
    }

    function setPanelImageUrl(i){
      const url = prompt("Paste a public image URL for this speaker:");
      if (!url) return;
      state.panel.speakers[i].imageUrl = url.trim();
      document.getElementById(`spImgStatus_${i}`).textContent = "URL set";
      persist();
      alert("‚úÖ Speaker image URL saved.");
    }

    function savePanel(){
      state.panel.enable = document.getElementById("enablePanel").checked;
      if (state.panel.enable){
        state.panel.count = parseInt(document.getElementById("panelCount").value, 10);
        for (let i=0;i<state.panel.count;i++){
          state.panel.speakers[i].name = document.getElementById(`spName_${i}`).value.trim() || `Speaker ${i+1}`;
          state.panel.speakers[i].voiceMode = document.getElementById(`spVoice_${i}`).value;
          const e = document.getElementById(`spElevenId_${i}`);
          if (e) state.panel.speakers[i].elevenVoiceId = e.value.trim();
          const o = document.getElementById(`spOpenaiVoice_${i}`);
          if (o) state.panel.speakers[i].openaiVoice = o.value;
        }
      }
      persist();
      alert("‚úÖ Panel settings saved.");
    }

    // -----------------------------
    // Scenes
    // -----------------------------
    function addScene(){
      const provider = document.getElementById("sceneProvider").value;
      const desc = document.getElementById("sceneDesc").value.trim();
      const after = parseInt(document.getElementById("insertAfter").value, 10);
      const seconds = parseInt(document.getElementById("sceneSeconds").value, 10);
      if (!desc){
        alert("Please describe the scene or add a label.");
        return;
      }
      state.scenes.push({
        provider,
        description: desc,
        insertAfter: isNaN(after) ? 1 : after,
        seconds
      });
      document.getElementById("sceneDesc").value = "";
      renderScenes();
      persist();
    }

    function removeScene(i){
      state.scenes.splice(i,1);
      renderScenes();
      persist();
    }

    function renderScenes(){
      const box = document.getElementById("sceneList");
      if (!state.scenes.length){
        box.innerHTML = `<div class="help">No scenes added yet.</div>`;
        return;
      }
      box.innerHTML = state.scenes.map((s,i)=>`
        <div class="scene-item">
          <div><strong>Scene ${i+1}</strong> <span class="pill" style="margin-left:6px">${s.provider}</span></div>
          <div style="margin-top:6px;color:#374151">${s.description}</div>
          <div class="small" style="margin-top:6px">Insert after segment: ${s.insertAfter} ‚Ä¢ Seconds: ${s.seconds}</div>
          <button class="btn light" style="margin-top:10px" onclick="removeScene(${i})">Remove</button>
        </div>
      `).join("");
    }

    function saveScenes(){
      persist();
      alert("‚úÖ Scenes saved.");
    }

    // -----------------------------
    // Produce
    // -----------------------------
    function selectTalkProvider(p, el){
      state.produce.talkProvider = p;
      // select only in same provider section
      el.parentElement.querySelectorAll(".provider").forEach(x=>x.classList.remove("selected"));
      el.classList.add("selected");
      persist();
    }

    function log(msg){
      document.getElementById("progressBox").style.display = "block";
      const l = document.getElementById("log");
      l.textContent += msg + "\n";
      l.scrollTop = l.scrollHeight;
    }

    function startProduction(){
      // Pull current UI fields
      state.setup.openaiKey = document.getElementById("openaiKey").value.trim();
      state.setup.elevenKey = document.getElementById("elevenKey").value.trim();
      state.setup.didKey = document.getElementById("didKey").value.trim();
      state.setup.heygenKey = document.getElementById("heygenKey").value.trim();
      state.setup.synthesiaKey = document.getElementById("synthesiaKey").value.trim();

      state.voice.mainMode = document.getElementById("voiceModeMain").value;
      state.languages.spoken = document.getElementById("spokenLang").value;
      state.languages.captions = document.getElementById("captionLang").value;

      state.captions.enable = document.getElementById("enableCaptions").checked;
      state.captions.burn = document.getElementById("burnCaptions").checked;

      state.script.mode = document.getElementById("scriptMode").value;
      state.script.text = document.getElementById("mainScript").value;
      state.script.ticker = document.getElementById("ticker").value.trim();

      state.studio.desc = document.getElementById("studioDesc").value;
      state.studio.enableTicker = document.getElementById("enableTicker").checked;

      state.produce.autoPreview = document.getElementById("autoPreview").checked;
      state.produce.autoDownload = document.getElementById("autoDownload").checked;

      const vId = document.getElementById("elevenVoiceIdMain");
      if (vId) state.voice.elevenVoiceId = vId.value.trim();
      const oa = document.getElementById("openaiVoiceMain");
      if (oa) state.voice.openaiVoice = oa.value;

      // Panel speaker fields if enabled
      state.panel.enable = document.getElementById("enablePanel").checked;
      if (state.panel.enable){
        savePanel();
      }

      persist();

      // Clear log
      document.getElementById("log").textContent = "";
      document.getElementById("resultBox").style.display = "none";
      document.getElementById("progressBox").style.display = "block";
      log("‚úì Starting production...");

      if (!window.google || !google.colab || !google.colab.kernel) {
        alert("This must run inside Google Colab output.");
        return;
      }

      google.colab.kernel.invokeFunction(
        "afrofuture.start_production",
        [JSON.stringify(state)],
        {}
      );
    }

    // Colab will call this to append logs
    window.afrofutureLog = function(message){
      log(message);
    }

    window.afrofutureDone = function(payloadJson){
      try{
        const payload = JSON.parse(payloadJson);
        document.getElementById("resultBox").style.display = "block";
        document.getElementById("resultText").innerHTML =
          `<div><strong>Final video:</strong> ${payload.final_video || "n/a"}</div>` +
          `<div><strong>Audio:</strong> ${payload.audio || "n/a"}</div>` +
          `<div><strong>SRT:</strong> ${payload.srt || "n/a"}</div>` +
          `<div style="margin-top:10px;color:#111827">${payload.message || ""}</div>`;
      } catch(e){
        document.getElementById("resultBox").style.display = "block";
        document.getElementById("resultText").innerHTML = "Completed, but could not parse payload.";
      }
      refreshSummary();
    }

    // -----------------------------
    // Code tab helpers
    // -----------------------------
    function generateConfigCode(){
      const json = JSON.stringify(state, null, 2);
      document.getElementById("configCode").textContent = json;
    }
    function copyConfig(){
      const txt = document.getElementById("configCode").textContent;
      navigator.clipboard.writeText(txt);
      alert("‚úÖ Copied.");
    }
    function downloadConfig(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "afrofuture_config.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // -----------------------------
    // Summary
    // -----------------------------
    function refreshSummary(){
      const sumImage = document.getElementById("sumImage");
      sumImage.textContent = state.media.mainImageUrl ? "Set" : "Not set";
      document.getElementById("sumVoice").textContent = state.voice.mainMode || "Not set";
      document.getElementById("sumSpoken").textContent = state.languages.spoken || "en";
      document.getElementById("sumCaps").textContent = state.captions.enable ? "On" : "Off";
      document.getElementById("sumPanel").textContent = state.panel.enable ? `On (${state.panel.count})` : "Off";
      document.getElementById("sumScenes").textContent = (state.scenes || []).length;
      document.getElementById("sumTalk").textContent = state.produce.talkProvider || "did";
      document.getElementById("mainImageStatus").textContent = state.media.mainImageUrl ? "Set" : "Not set";
      const audioStatus = document.getElementById("audioStatus");
      if (audioStatus) audioStatus.textContent = state.media.uploadedAudioLabel || "Not set";
    }

    // -----------------------------
    // Initialize
    // -----------------------------
    load();

    // Populate fields
    document.getElementById("openaiKey").value = state.setup.openaiKey || "";
    document.getElementById("elevenKey").value = state.setup.elevenKey || "";
    document.getElementById("didKey").value = state.setup.didKey || "";
    document.getElementById("heygenKey").value = state.setup.heygenKey || "";
    document.getElementById("synthesiaKey").value = state.setup.synthesiaKey || "";

    document.getElementById("voiceModeMain").value = state.voice.mainMode || "eleven_tts";
    document.getElementById("spokenLang").value = state.languages.spoken || "en";
    document.getElementById("captionLang").value = state.languages.captions || "same";
    document.getElementById("enableCaptions").checked = !!state.captions.enable;
    document.getElementById("burnCaptions").checked = !!state.captions.burn;

    document.getElementById("scriptMode").value = state.script.mode || "custom";
    document.getElementById("mainScript").value = state.script.text || "";
    document.getElementById("ticker").value = state.script.ticker || "";

    document.getElementById("studioDesc").value = state.studio.desc || "";
    document.getElementById("enableTicker").checked = (state.studio.enableTicker !== false);

    document.getElementById("enablePanel").checked = !!state.panel.enable;
    document.getElementById("panelCount").value = String(state.panel.count || 3);

    renderVoiceFields();
    renderScriptMode();
    renderPanel();
    renderScenes();
    refreshSummary();
  </script>
</body>
</html>
